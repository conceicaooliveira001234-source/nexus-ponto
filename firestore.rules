rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ═══════════════════════════════════════════════════════════════
    // COMPANIES - Apenas usuários autenticados podem ler/escrever
    // ═══════════════════════════════════════════════════════════════
    match /companies/{companyId} {
      allow read, write: if request.auth != null;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // EMPLOYEES - Leitura pública para reconhecimento facial
    // ═══════════════════════════════════════════════════════════════
    match /employees/{employeeId} {
      // Leitura pública é necessária para que o sistema possa comparar
      // o rosto do usuário com os funcionários cadastrados.
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // LOCATIONS - Leitura pública para seleção de local pelo funcionário
    // ═══════════════════════════════════════════════════════════════
    match /locations/{locationId} {
      // Leitura pública é necessária para que o funcionário possa
      // ver e selecionar seu local de trabalho no painel.
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // USERS - Apenas o próprio usuário pode ler/escrever seus dados
    // ═══════════════════════════════════════════════════════════════
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // ATTENDANCE - ACESSO PÚBLICO PARA CRIAR REGISTROS
    // ═══════════════════════════════════════════════════════════════
    // Funcionários usam reconhecimento facial (não Firebase Auth)
    // Por isso, precisam de permissão pública para criar registros
    // ═══════════════════════════════════════════════════════════════
    match /attendance/{attendanceId} {
      // LEITURA: Qualquer pessoa pode ler (para o histórico)
      allow read: if true;
      
      // CRIAÇÃO: Qualquer pessoa pode criar (para registrar ponto)
      allow create: if true;
      
      // ATUALIZAÇÃO E EXCLUSÃO: Apenas usuários autenticados (admins)
      allow update, delete: if request.auth != null;
    }
  }
}
