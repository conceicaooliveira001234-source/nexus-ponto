rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ═══════════════════════════════════════════════════════════════
    // COMPANIES - Apenas o dono da empresa pode ler/escrever
    // ═══════════════════════════════════════════════════════════════
    match /companies/{companyId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // EMPLOYEES - Leitura pública para reconhecimento facial
    // ═══════════════════════════════════════════════════════════════
    match /employees/{employeeId} {
      // Leitura pública é necessária para que o sistema possa comparar
      // o rosto do usuário com os funcionários cadastrados.
      allow read: if true;
      // Escrita permitida apenas para o admin da empresa dona do funcionário.
      allow create: if request.auth != null && request.resource.data.companyId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.companyId == request.auth.uid;
			allow update: if
        // Admin pode atualizar
        (request.auth != null && resource.data.companyId == request.auth.uid) ||
        // Funcionário pode cadastrar o rosto uma vez via link
        (
          request.auth == null &&
          (resource.data.photoBase64 == null || resource.data.photoBase64 == "") &&
          request.resource.data.photoBase64 is string && request.resource.data.photoBase64 != "" &&
          request.resource.data.name == resource.data.name &&
          request.resource.data.cpf == resource.data.cpf &&
          request.resource.data.companyId == resource.data.companyId &&
          request.resource.data.role == resource.data.role &&
          request.resource.data.whatsapp == resource.data.whatsapp &&
          request.resource.data.shifts == resource.data.shifts &&
          request.resource.data.locationIds == resource.data.locationIds &&
          request.resource.data.pin == resource.data.pin &&
          request.resource.data.shift == resource.data.shift &&
          request.resource.data.entryTime == resource.data.entryTime &&
          request.resource.data.breakTime == resource.data.breakTime &&
          request.resource.data.exitTime == resource.data.exitTime
        );
    }
    
    // ═══════════════════════════════════════════════════════════════
    // LOCATIONS - Leitura pública para seleção de local pelo funcionário
    // ═══════════════════════════════════════════════════════════════
    match /locations/{locationId} {
      // Leitura pública é necessária para que o funcionário possa
      // ver e selecionar seu local de trabalho no painel.
      allow read: if true;
      // Escrita permitida apenas para o admin da empresa dona do local.
      allow create: if request.auth != null && request.resource.data.companyId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.companyId == request.auth.uid;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // USERS - Apenas o próprio usuário pode ler/escrever seus dados
    // ═══════════════════════════════════════════════════════════════
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // ATTENDANCE - ACESSO PÚBLICO PARA CRIAR REGISTROS
    // ═══════════════════════════════════════════════════════════════
    // Funcionários usam reconhecimento facial (não Firebase Auth)
    // Por isso, precisam de permissão pública para criar registros
    // ═══════════════════════════════════════════════════════════════
    match /attendance/{attendanceId} {
      // LEITURA: Qualquer pessoa pode ler (para o histórico)
      allow read: if true;

      // CRIAÇÃO: Apenas registros válidos do app de ponto
      allow create: if request.resource.data.verified == true
                    && request.resource.data.employeeId is string
                    && request.resource.data.type in ['ENTRY', 'BREAK_START', 'BREAK_END', 'EXIT'];

      // ATUALIZAÇÃO: Apenas usuários autenticados (admins)
      allow update: if request.auth != null;

      // EXCLUSÃO: Apenas admins, ou para limpar documentos de teste
      allow delete: if request.auth != null || (resource.data.isTest == true);
    }
  }
}
